<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Usage Counter</title>
<style>
  body { font-family: Arial, sans-serif; background: #1e1e1e; color: #f0f0f0; display: flex; flex-direction: column; align-items: center; padding: 50px; }
  input, button { padding: 8px 12px; margin: 5px; border-radius: 4px; border: none; font-size: 1rem; }
  input { width: 200px; }
  button { cursor: pointer; }
  button:disabled { opacity: 0.5; cursor: not-allowed; }
  #status { margin-top: 20px; min-height: 20px; color: #ff6b6b; }
  #count { margin-top: 10px; font-size: 1.5rem; font-weight: bold; }
</style>
</head>
<body>
<h1>Usage Counter</h1>
<input type="text" id="nameInput" placeholder="Enter name" />
<div>
  <button id="startBtn">Start</button>
  <button id="incBtn" disabled>Increment</button>
  <button id="refreshBtn" disabled>Refresh</button>
  <button id="forgetBtn" disabled>Forget</button>
</div>
<div id="count">--</div>
<div id="status"></div>
<script>
const nameInput = document.getElementById('nameInput');
const startBtn = document.getElementById('startBtn');
const incBtn = document.getElementById('incBtn');
const refreshBtn = document.getElementById('refreshBtn');
const forgetBtn = document.getElementById('forgetBtn');
const statusEl = document.getElementById('status');
const countEl = document.getElementById('count');

let currentName = null;

function setStatus(msg, isError = true) {
  statusEl.textContent = msg;
  statusEl.style.color = isError ? '#ff6b6b' : '#4caf50';
}

function setButtons(enabled) {
  incBtn.disabled = !enabled;
  refreshBtn.disabled = !enabled;
  forgetBtn.disabled = !enabled;
}

async function postIncrement(name) {
  try {
    const res = await fetch('https://api.magiqspark.com/counter/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name })
    });
    if (!res.ok) throw new Error('Failed to increment');
  } catch (err) {
    setStatus(err.message);
  }
}

async function getCount(name) {
  try {
    const res = await fetch(`https://api.magiqspark.com/counter/?name=${encodeURIComponent(name)}`);
    if (!res.ok) throw new Error('Failed to fetch count');
    const data = await res.json();
    countEl.textContent = data.count ?? '--';
    setStatus('', false);
  } catch (err) {
    setStatus(err.message);
  }
}

startBtn.addEventListener('click', async () => {
  const name = nameInput.value.trim();
  if (!name) return setStatus('Name cannot be empty');
  currentName = name;
  setButtons(true);
  await postIncrement(currentName);
  await getCount(currentName);
});

incBtn.addEventListener('click', async () => {
  if (!currentName) return;
  await postIncrement(currentName);
  await getCount(currentName);
});

refreshBtn.addEventListener('click', async () => {
  if (!currentName) return;
  await getCount(currentName);
});

forgetBtn.addEventListener('click', () => {
  currentName = null;
  countEl.textContent = '--';
  setButtons(false);
  setStatus('', false);
});

// Auto-start if ?name=foo is present
window.addEventListener('DOMContentLoaded', async () => {
  const params = new URLSearchParams(window.location.search);
  const name = params.get('name');
  if (name) {
    nameInput.value = name;
    startBtn.click();
  }
});
</script>
</body>
</html>
